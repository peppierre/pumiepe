/*! pumiepe 19-05-2015 */
!function(a,b){"use strict";var c,d,e,f,g,h,i,j;if("undefined"==typeof $)throw new g("No jQuery library found.");e=a.sessionStorage,d=a.localStorage,f=function(){},f.generateStandardMessage=function(a){var b,c;return b=new Date,c=b.getFullYear(),c+="-"+(b.getMonth()<9?"0":"")+(b.getMonth()+1),c+="-"+(b.getDate()<10?"0":"")+b.getDate(),c+=" "+(b.getHours()<10?"0":"")+b.getHours(),c+=":"+(b.getMinutes()<10?"0":"")+b.getMinutes(),c+=":"+(b.getSeconds()<10?"0":"")+b.getSeconds(),c+="."+(b.getMilliseconds()<10?"0":"")+(b.getMilliseconds()<100?"0":"")+b.getMilliseconds(),"["+c+"] [PUMIEPE] "+a},f.log=function(a){console&&console.log(f.generateStandardMessage(a))},f.info=function(a){console&&console.info(f.generateStandardMessage(a))},f.warn=function(a){console&&console.warn(f.generateStandardMessage(a))},f.error=function(a){console&&console.error(f.generateStandardMessage(a))},g=function(){},g.STORAGE_VARIABLE_NAME="latest-error",g["throw"]=function(a,b,c){e.setItem(g.STORAGE_VARIABLE_NAME,JSON.stringify({code:a,name:b,details:c})),j.transitionTo(i.ROUTE_PATH_ERROR)},h=function(){},h.parseFromUrl=function(a){return a.split("#")[1]||"/"},h.parseHashesFromChangeEvent=function(a){return{from:h.parseFromUrl(a.oldURL),to:h.parseFromUrl(a.newURL)}},h.normalize=function(a){return a="#"===a.charAt(0)?a.substr(1,a.length):a,a=("/"!==a.charAt(0)?"/":"")+a,a="/"!==a.charAt(a.length-1)?a:a.substr(0,a.length-1)},i=function(){},i.ROUTE_PATH_INDEX="/",i.ROUTE_PATH_LOADING="/loading",i.ROUTE_PATH_ERROR="/error",i.ROUTE_TEMPLATEFILE_INDEX="index.hbs",i.ROUTE_TEMPLATEFILE_LOADING="loading.hbs",i.ROUTE_TEMPLATEFILE_ERROR="error.hbs",i.ROUTE_TEMPLATE_INDEX="<h1>Application is running</h1>",i.ROUTE_TEMPLATE_LOADING="Loading... Please wait!",i.ROUTE_TEMPLATE_ERROR="<h1>{{code}} - {{name}}</h1><div>{{details}}</div>",j=function(){var c,d,j,k,l,m;return j={},k=function(a){var c,d;return d=h.normalize(a).split("/"),c=function(){var a,b,c,e,f;f=[];for(a in j)if(j.hasOwnProperty(a)){if(b=h.normalize(a).split("/"),e=b.length,c=0,e===d.length)for(;(b[c]===d[c]||":"===b[c][0])&&e>c;)":"===b[c][0]&&(j[a].parameters[b[c].substr(1)]=d[c]),c+=1;c===e&&f.push(j[a])}return f}(),c.length>0?c[0]:b},l=function(a){var c;c=k(a),c!==b&&c.navigateAway(),k(i.ROUTE_PATH_LOADING).navigateTo()},m=function(a){var c;k(i.ROUTE_PATH_LOADING).navigateAway(),c=k(a),c!==b?c.navigateTo():g["throw"](404,"No route found: "+a,"Requested route was not defined. Please, contact to application owner!")},$(a).on("hashchange",function(a){var b;b=h.parseHashesFromChangeEvent(a.originalEvent),b.to!==i.ROUTE_PATH_LOADING&&(l(b.from),m(b.to))}),$(document).ready(function(){k(i.ROUTE_PATH_INDEX)===b&&d.facture(i.ROUTE_PATH_INDEX,i.ROUTE_TEMPLATEFILE_INDEX),m(h.normalize(a.location.hash))}),c=function(a,b){var d,e,h,j,k,l,m,n,o,p,q;d=this,h=a,j=null,k=null,e={model:{}},l=function(){return!0},m=function(){return{}},n=function(a){return a},o=function(){return new Promise(function(a,b){a(this)}).then(function(){return d.beforeModel.apply(d)}).then(function(){return d.onModel.apply(d,[d.parameters])}).then(function(a){return e.model=a,d.afterModel.apply(d,[e.model])}).then(function(a){return e.model=a,!0},function(){g["throw"](404,"Unable to navigate to route","Something unusual happend while getting relevant model. Please, contact to application owner!")})},p=function(){return null===j?(h===i.ROUTE_TEMPLATEFILE_INDEX&&(j=Handlebars.compile(i.ROUTE_TEMPLATE_INDEX)),h===i.ROUTE_TEMPLATEFILE_ERROR&&(j=Handlebars.compile(i.ROUTE_TEMPLATE_ERROR)),h===i.ROUTE_TEMPLATEFILE_LOADING&&(j=Handlebars.compile(i.ROUTE_TEMPLATE_LOADING)),Promise.resolve($.ajax("/views/"+h)).then(function(a){j=Handlebars.compile(a)},function(){h!==i.ROUTE_TEMPLATEFILE_INDEX&&h!==i.ROUTE_TEMPLATEFILE_ERROR&&h!==i.ROUTE_TEMPLATEFILE_LOADING&&g["throw"](404,"View is unavailable for "+h,"Something unusual happend while getting relevant template. Please, contact to application owner!")})):!0},this.parameters={},this.beforeModel=l,this.onModel=m,this.afterModel=n,this.navigateAway=function(){d.setdownEventHandlers.call(e)},this.navigateTo=function(){Promise.all([o.call(this),p.call(this)]).then(function(){$("body main").html(j(e.model)),d.setupEventHandlers.call(e)},function(){g["throw"](404,"Unable to navigate to route","Something unusual happened while getting relevant model or template. Please, contact to application owner!")})},this.setupEventHandlers=function(){f.log("Setup event handlers")},this.setdownEventHandlers=function(){f.log("Setdown event handlers")};for(q in b)b.hasOwnProperty(q)&&c.unmutables.indexOf(q)<0&&(this[q]=b[q])},c.unmutables=["parameters","view","model","environment","navigateAway","navigateTo"],d={transitionTo:function(b){a.location.replace(a.location.href.substr(0,a.location.href.indexOf(a.location.hash))+"#"+b)},facture:function(a,b,d){return a=h.normalize(a),j[a]?void f.warn("Duplicated route path: "+a):void(j[a]=new c(b,d))}},d.facture(i.ROUTE_PATH_ERROR,i.ROUTE_TEMPLATEFILE_ERROR,{onModel:function(){return JSON.parse(e.getItem(g.STORAGE_VARIABLE_NAME))}}),d.facture(i.ROUTE_PATH_LOADING,i.ROUTE_TEMPLATEFILE_LOADING),d}(),c=function(){return{$:$,Persistence:d,Session:e,showError:g["throw"],route:j.facture,navigateTo:j.transitionTo}},c.VERSION="0.1.5",a.PUMIEPE=new c}(this);